<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="不求深刻,但求简单."><title> | 一朵西兰花</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/3.0.3/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/2.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/rss+xml" href="/rss2.xml"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">一朵西兰花</h1><a id="logo" href="/.">一朵西兰花</a><p class="description">不求深刻,但求简单.</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title"></h1><div class="post-meta">Apr 16, 2016<script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> Hits</span></span></div><a data-disqus-identifier="2016/04/16/im/" href="/2016/04/16/im/#disqus_thread" class="disqus-comment-count"></a><div class="post-content"><p>本文主要以Android客户端为例，记录了有赞旗下App中使用自研IM SDK 设计思路，由有赞移动开发组IM SDK团队共同讨论完成。</p>
<ul>
<li><a href="#1">1.语法示例</a></li>
</ul>
<h2 id="1">1.语法示例</h2>

<p>在有赞产品中，存在大量需要交易双方沟通交流的场景，比如，客户咨询商家产品信息，售前售后简单的答疑和维权等。此时需要较为完善的即时通信（IM）解决方案，但是由于有赞针对不同的商户和使用场景有多个APP，APP自行实现IM功能代价较大，且维护起来人力分散，于是，IM SDK 项目便应运而生了，APP 通过接入此SDK，可以快速实现IM基本功能。</p>
<h1 id="u8BBE_u8BA1_u76EE_u6807"><a href="#u8BBE_u8BA1_u76EE_u6807" class="headerlink" title="设计目标"></a>设计目标</h1><ul>
<li>IM 主流程稳定可用：消息传输具有高可靠性。</li>
<li>UI 组件直接集成进入SDK，并支持可定制化。</li>
<li>富媒体发送集成进入SDK，并可按需定制需要的富媒体类型。</li>
<li>实现消息传输层SDK，与带有UI的SDK的功能分离，业务调用方既可以使用消息传输SDK，处理消息，然后自行处理UI，也可以使用带有UI组件的sdk，一步实现较为完备的IM功能。</li>
</ul>
<h1 id="u6574_u4F53_u7ED3_u6784"><a href="#u6574_u4F53_u7ED3_u6784" class="headerlink" title="整体结构"></a>整体结构</h1><p>下图中简要描述了有赞客户端中IM系统的基本结构<br><img src="/content/images/2016/04/IM------1.png" alt="">  </p>
<ul>
<li>消息通道层：维护Socket长连接作为消息通道，消息收发流程主要在这一层中完成。  </li>
<li>持久化层：主要将消息存入数据库中，富媒体文件存入文件缓存中，方便第二次展示消息时候，从本地加载，而不是网络层获取。  </li>
<li>逻辑处理层：完成各种消息相关的逻辑处理，如排序，富媒体文件的预处理等。  </li>
<li>UI显示层：将数据在UI上进行呈现。</li>
</ul>
<p>#设计要点<br>此章节中主要描述了，IM SDK设计中一些重要流程。</p>
<p>##Socket长链接的创建与维护<br>IM SDK 所有数据收发流程，均通过Socket长连接完成，如何维护一个稳定Socket通道，是IM系统是否稳定的重要一环。<br>下面描述下Socket通道几个重要的流程  </p>
<ul>
<li><p>创建流程（连接）<br> <img src="/content/images/2016/04/-------.png" alt=""><br> 如图所示，当IM SDK初始化后，业务调用连接请求接口，会开始连接的创建过程，创建成功后，会完成鉴权操作，当创建和鉴权都完成后，会开启消息收发线程，为了维持长连接，会有心跳机制，特别的，会开启一个心跳轮询线程。 </p>
</li>
<li><p>心跳<br> 心跳机制，是IM系统设计中的常见概念，简单的解释就是每隔若干时间发送一个固定信息给服务端，服务端收到后及时回复一个固定信息，如果服务端若干时间内没有收到客户端心跳信息则视客户端断开，同理如果客户端若干时间没有收到服务端心跳回值则视服务端断开。<br> <img src="/content/images/2016/04/--------2.png" alt=""><br> 当长连接创建成功后，会开启一个轮询线程，每隔一段时间发送心跳消息给服务器端，已维持长连接。</p>
</li>
<li><p>重连流程<br> <img src="/content/images/2016/04/im------1.png" alt=""><br> 重连被触发时，如果该次连接成功，退出重连。反之重连失败后，会判断当前重连的次数是否超过预期值（这里设为6次），并对重连次数计数，如果超过就会退出重连，反之休眠预设的时间后再次进行重连操作。<br> 重连触发条件分为三种：  </p>
<ul>
<li>主动连接不成功（主动连接Socket，如果连接失败，会触发重连机制)  </li>
<li>网络被主动断开（正常建立连接，操作过程中，网络被断开，通过系统广播触发重连）  </li>
<li>服务器没响应，心跳没回值（服务端心跳预设时间内没回值，客户端认为服务端已经断开，触发重连） </li>
</ul>
</li>
<li>网络状态判断<br>TCP API并没有提供一个可靠的方法判断当前长连接通道状态，isConnected()和isClosed()仅仅告诉你当前的Socket状态，不是是长连接断开是一回事。<br>isConnected()告诉你是否Socket与Romote host保持连接，isClosed()告诉你是否Socket被关闭。<br>假如你判断长连接通道是否被关闭，只能通过和流操作相关的以下方法：<br>1：read() return -1<br>2：readLine() return null<br>3：readXXX() throw EOPException for any other XXX<br>4：write 将抛出IOException: Broken pipe(通道被关闭)<br>所以SDK封装isConnected（）方法的时候，是根据这几种情况综合判断当前的通道状态，而不是仅仅通过Socket.isConnected（）或者Socket.isClosed（）。</li>
</ul>
<p>##消息发送流程<br><img src="/content/images/2016/04/-------1.png" alt=""><br>消息发送流程主要有两大类，一类是IM相关数据的请求，例如：历史消息列表，会话列表等，另一类是IM消息的发送，主要是文字消息。（富媒体消息发送，会将富媒体文件先上传服务器后，拿到文件URL, 通过文字消息，将此URL发给接收方，接收方下载后进行UI展示）。  此两类消息发送，均使用上图的流程进行发送，可通过发送回调感知请求的结果。  </p>
<p>如图所示，消息发送流程，需要先封装消息请求，在通过发送队列发送至服务器，发送前，在将请求id和对应回调存入本地Map数据结构中。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (requestCallBack != <span class="keyword">null</span>) &#123;</span><br><span class="line">    mCallBackMap.put(requestId, requestCallBack);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>之后接收服务器推送消息（此消息带有发送请求时的请求id），在本地的Map数据找到请求id对应的回调，然后通过回调返回服务器推送过来的数据。<br>请求可以通过泛型指定返回值类型，SDK中会自行解析服务器数据返回的数据，直接返回给业务调用方model对象，方便使用。（目前支持json格式的数据解析）<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">IMResponseOnSuccess</span><span class="params">(String requestid, String response)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mCallBackMap != <span class="keyword">null</span>) &#123;</span><br><span class="line">        IMCallBack callBack = mCallBackMap.get(requestid);</span><br><span class="line">        <span class="keyword">if</span> (callBack == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (callBack <span class="keyword">instanceof</span> JsonResultCallback) &#123;</span><br><span class="line">            <span class="keyword">final</span> JsonResultCallback resultCallback = (JsonResultCallback) callBack;</span><br><span class="line">            <span class="keyword">if</span> (resultCallback.mType == String.class) &#123;</span><br><span class="line">                callBack.onResponse(response);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                Object object = <span class="keyword">new</span> Gson().fromJson(response, resultCallback.mType);</span><br><span class="line">                callBack.onResponse(object);</span><br><span class="line">            &#125;</span><br><span class="line">            removeCallBack(requestid);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>如下的示例中，展示了一个获取会话列表的请求，可以看出目前的请求封装，和一些第三方的的网络库类似，使用起来较为方便。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"> RequestApi requestApi = <span class="keyword">new</span> RequestApi(IMConstant.REQ_TYPE_GET_CONVERSATION_LIST, EnumsManager.IMType.IM_TYPE_WSC.getRequestChannel());</span><br><span class="line"> requestApi.addRequestParams(<span class="string">"limit"</span>, <span class="number">100</span>);</span><br><span class="line"> requestApi.addRequestParams(<span class="string">"offset"</span>, <span class="number">0</span>);</span><br><span class="line"> IMEngine.getInstance().request(requestApi, <span class="keyword">new</span> JsonResultCallback&lt;List&lt;ConversationEntity&gt;&gt;() &#123;</span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResponse</span><span class="params">(List&lt;ConversationEntity&gt; response)</span> </span>&#123;</span><br><span class="line">        mSwipeRefreshLayout.setRefreshing(<span class="keyword">false</span>);</span><br><span class="line">        mAdapter.mDataset.clear();</span><br><span class="line">        mAdapter.mDataset.addAll(response);</span><br><span class="line">        mAdapter.notifyDataSetChanged();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(<span class="keyword">int</span> statusCode)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//do something</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>可以看出，该请求直接返回了一个会话类型的List集合，业务方可直接使用。</p>
<p>##消息接收流程<br><img src="/content/images/2016/04/-------3.png" alt=""></p>
<p>消息的监听流程主要使用了一个全局监听的方式来进行，需要先注册监听器，监听器中有默认的回调。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IMListener</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * 连接成功</span><br><span class="line">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">connectSuccess</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * 连接失败</span><br><span class="line">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">connectFailure</span><span class="params">(EnumsManager.DisconnectType type)</span></span>;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * 鉴权成功</span><br><span class="line">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">authorSuccess</span><span class="params">()</span></span>;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * 鉴权失败</span><br><span class="line">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">authorFailure</span><span class="params">()</span></span>;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * 接收数据成功</span><br><span class="line">     *</span><br><span class="line">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">receiveSuccess</span><span class="params">(<span class="keyword">int</span> reqType, String msgId, String requestChannel, String message, <span class="keyword">int</span> statusCode)</span></span>;</span><br><span class="line"></span><br><span class="line">     <span class="comment">/**</span><br><span class="line">     * 接收数据失败</span><br><span class="line">     *</span><br><span class="line">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">receiveError</span><span class="params">(<span class="keyword">int</span> reqType, String msgId, String requestChannel, <span class="keyword">int</span> statusCode)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>该监听器中可以接收如下类型的消息：  </p>
<ul>
<li>Socket连接状态的返回结果。  </li>
<li>鉴权状态的返回结果，（鉴权流程因有赞业务需要）。  </li>
<li>接收的IM消息，或者其他类型的返回消息。可根据消息类型进行后续的分发处理  </li>
</ul>
<p>业务如需使用此全局监听器，需要自行实现此接口，并在业务初始化时，注册此监听器即可。SDK中会根据注册的监听器，在读取到服务器推送消息后，直接通过监听器到回调进行分发。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">distributeData</span><span class="params">(IMEntity imEntity)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mIMListener != <span class="keyword">null</span> &amp;&amp; imEntity != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 省略部分逻辑代码</span></span><br><span class="line">            ……</span><br><span class="line">            <span class="keyword">if</span> (status == Response.SUCCESS) &#123;</span><br><span class="line">                <span class="keyword">switch</span> (responseModel.reqType) &#123;</span><br><span class="line">                    <span class="keyword">case</span> IMConstant.REQ_TYPE_AUTH: <span class="comment">// 鉴权成功</span></span><br><span class="line">                        mIMListener.authorSuccess();</span><br><span class="line">                        <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">case</span> IMConstant.REQ_TYPE_OFFLINE: <span class="comment">//  服务端踢客户端下线</span></span><br><span class="line">                        mIMListener.connectFailure(EnumsManager.DisconnectType.SERVER);</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">case</span> IMConstant.REQ_TYPE_HEARTBEAT: <span class="comment">// 心跳成功</span></span><br><span class="line">                    <span class="keyword">case</span> IMConstant.REQ_TYPE_RECEIVER_MSG: <span class="comment">// 收到回调消息</span></span><br><span class="line">                        handleMessageID(responseModel.body);</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">default</span>:</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                mIMListener.receiveSuccess(responseModel.reqType, msgId, responseModel</span><br><span class="line">                        .requestChannel, responseModel.body, <span class="number">0</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                mIMListener.receiveError(responseModel.reqType, msgId, responseModel</span><br><span class="line">                        .requestChannel, status);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>部分接收消息，如心跳，多端登录时被踢下线通知等，sdk内部会自行处理，业务基本无感知。</p>
<p>##可定制化的UI<br>随着公司规模的扩大与业务线的快速迭代，可能新的业务也需要IM 这个功能，众所周知，IM UI功能的嵌入会占据大量的开发与调试时间,  为了解决这个痛点，决定将IM UI部分抽成一个Library，实现可定制与单独维护，做到真正的敏捷开发与快速迭代。</p>
<h3 id="UIKit_u8BBE_u8BA1"><a href="#UIKit_u8BBE_u8BA1" class="headerlink" title="UIKit设计"></a>UIKit设计</h3><p><img src="/content/images/2016/04/UIKit----1.png" alt=""><br>IM UIKit暴露相应的api接口，业务方注入相应的功能定制项，<br>针对UI的点击回调通过EventBus总线post分发，减少了业务方与UIKit的耦合，底层业务方通过MVP模式对View与Model进行解耦。定制项一般通过如下几种方式:  </p>
<ul>
<li><p>XML(定制业务信息，资源信息，显示条数，各个业务功能开关等)  </p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span><br><span class="line">&lt;resources&gt;</span><br><span class="line">    &lt;style name="limit"&gt;</span><br><span class="line">        &lt;!--每屏展示的条数--&gt;</span><br><span class="line">        &lt;item name="swiplimit"&gt;5&lt;/item&gt;</span><br><span class="line">        ......</span><br><span class="line">    &lt;/style&gt;</span><br><span class="line">	......</span><br><span class="line">	......</span><br><span class="line">    &lt;style name="itembox"&gt;</span><br><span class="line">        &lt;item name="showvoice"&gt;true&lt;/item&gt;</span><br><span class="line">        ......</span><br><span class="line">        ......</span><br><span class="line">        &lt;item name="more" show="true"&gt;</span><br><span class="line">            &lt;more&gt;</span><br><span class="line">                &lt;icon style="mipmap"&gt;im_plus_image&lt;/icon&gt;</span><br><span class="line">                &lt;itemname&gt;测试&lt;/itemname&gt;</span><br><span class="line">                &lt;callback&gt;false&lt;/callback&gt;</span><br><span class="line">            &lt;/more&gt;</span><br><span class="line">             ......</span><br><span class="line">             ......</span><br><span class="line">            &lt;more&gt;</span><br><span class="line">                &lt;icon style="mipmap"&gt;ic_launcher&lt;/icon&gt;</span><br><span class="line">                &lt;itemname&gt;测试&lt;/itemname&gt;</span><br><span class="line">                &lt;callback&gt;true&lt;/callback&gt;</span><br><span class="line">            &lt;/more&gt;</span><br><span class="line">        &lt;/item&gt;</span><br><span class="line">        ......</span><br><span class="line">        ......</span><br><span class="line">    &lt;/style&gt;</span><br><span class="line">&lt;/resources&gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p>Style(定制UI背景，气泡颜色，字体大小等)</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span><br><span class="line">&lt;resources&gt;</span><br><span class="line">    &lt;!--im 聊天背景--&gt;</span><br><span class="line">    &lt;style name="imui_background"&gt;</span><br><span class="line">        &lt;item name="android:background"&gt;@android:color/holo_red_dark&lt;/item&gt;</span><br><span class="line">    &lt;/style&gt;</span><br><span class="line">	......</span><br><span class="line">	......</span><br><span class="line"></span><br><span class="line">    &lt;!--气泡背景--&gt;</span><br><span class="line">    &lt;style name="bubble_background"&gt;</span><br><span class="line">        &lt;item name="android:background"&gt;@mipmap/bubble_right_green&lt;/item&gt;</span><br><span class="line">    &lt;/style&gt;</span><br><span class="line"></span><br><span class="line">       &lt;!--背景和和字段颜色定制--&gt;</span><br><span class="line">    &lt;style name="bg_and_textcolor" parent="bubble_background"&gt;</span><br><span class="line">        &lt;item name="android:textColor"&gt;@android:color/holo_red_dark&lt;/item&gt;</span><br><span class="line">    &lt;/style&gt;</span><br><span class="line">    ......</span><br><span class="line">    ......</span><br><span class="line">&lt;/resources&gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p>model定制（传入预设的定制Model模板填入相应参数，UIKit里面做相应解析）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Entity</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> String action1;</span><br><span class="line">    <span class="keyword">public</span> String action2;</span><br><span class="line">    <span class="keyword">public</span> String aciton3;</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="UIKit_u652F_u6301_u7684_u5BCC_u5A92_u4F53_u7C7B_u578B"><a href="#UIKit_u652F_u6301_u7684_u5BCC_u5A92_u4F53_u7C7B_u578B" class="headerlink" title="UIKit支持的富媒体类型"></a>UIKit支持的富媒体类型</h3><p>除了文字消息之外，现在主流的IM系统中也支持各种富媒体发送，在有赞IM SDK UIKit中，目前也支持几种富媒体发送。 以下是发送流程图和两类常见富媒体消息简介。</p>
<ul>
<li>语音消息<br>语音消息，除了使用常见的录制和解码播放的技术之外。而利用了    <code>AudioManager</code>中 <code>requestAudioFocus</code>，<code>abandonAudioFocus</code>相关方法，实现了录制和播放语音消息，如果有第三方播放音乐，会自动暂停，录制和播放语音消息结束后，声音会自动播放。</li>
<li>图片消息<br>图片消息，通过七牛服务器设置了缩略图，接收方收到消息后，会先下载缩略图，当用户再点击进入图片详情页时，会下载大图，Andorid客户端使用Picasso加载库加载图片，并做本地缓存。</li>
</ul>
<p>##UI中聊天会话数据加载策略<br>参考业界主流的IM系统方案，用户聊天时，需要将已经发送和接受到的聊天信息保存到本地。而不是每次都拉取历史数据。以达到节约流量和无网络状态下也查看数据的效果。为此IM SDK持久化层的数据库中，也实现了简单存储加载机制，下面描述典型的数据加载场景。  </p>
<ul>
<li><p>IM会话首次请求数据流程<br><img src="/content/images/2016/04/IM----------.png" alt=""></p>
</li>
<li><p>IM下拉获取历史数据流程<br><img src="/content/images/2016/04/IM-----------2.png" alt=""></p>
</li>
<li><p>IM单条消息发送持久化方案<br><img src="/content/images/2016/04/IM-----------.png" alt=""></p>
</li>
<li><p>IM单条数据重发流程<br><img src="/content/images/2016/04/IM--------.png" alt=""><br>#设计不足之处</p>
</li>
<li>消息回执<br>当前的设计方案中，没有消息回执的机制，也就是说接受方收到消息后，不会返回服务器收到消息的通知，服务器无法判断消息是否推送成功，这样在突然断网，网络模式切换，或者弱网环境下，会影响消息的到达率。<br>一种可行的设计方式是，发送方增加已送到和未送达的状态，接收方收到消息后，给服务器返回已收到消息的通知，服务器再推送给发送方该状态，如果没有收到接收方回执，服务器可尝试重新推送。发送方接受到接收方的收到回执后，更新发送状态已发送，如果未收到，则显示未送达。为了防止接收方回执丢失，接收方接收消息时候，可维护本地去重队列。  </li>
<li>本地请求超时的判断<br>本地发起的请求，没有用定时器，完全依赖服务器返回或者出现Socket通道异常后上抛的通知作为超时判断，部分场景可能覆盖不到，需要对请求增加固定的超时处理机制，固定时候未收到请求，即认为超时。<br>#未来发展方向</li>
<li>增加对群聊的支持。</li>
<li>弥补设计中的不足之处，提升消息的到达率和系统稳定性。</li>
<li>提供有赞App更方便的接入方式，提供封装性更好的接口。</li>
</ul>
</div><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a data-url="http://broccolii.github.io/2016/04/16/im/" data-id="cin2u6vyx0002r820kucdtc11" class="article-share-link">分享到</a><div class="tags"></div><div class="post-nav"><a href="/2016/04/16/Swift_algorithm/" class="next">Swift 中简单的算法题</a></div><div id="disqus_thread"><script>var disqus_shortname = 'broccoliii';
var disqus_identifier = '2016/04/16/im/';
var disqus_title = '';
var disqus_url = 'http://broccolii.github.io/2016/04/16/im/';
(function() {
  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//broccoliii.disqus.com/count.js" async></script></div></div></div></div><div class="pure-u-1-4"><div id="sidebar"><div class="widget"><input placeholder="Search" type="text" class="st-default-search-input"/></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/UITableView/" style="font-size: 15px;">UITableView</a> <a href="/tags/Thread/" style="font-size: 15px;">Thread</a> <a href="/tags/Database/" style="font-size: 15px;">Database</a> <a href="/tags/RunLoop/" style="font-size: 15px;">RunLoop</a> <a href="/tags/CoreSpotlight/" style="font-size: 15px;">CoreSpotlight</a> <a href="/tags/3DTouch/" style="font-size: 15px;">3DTouch</a> <a href="/tags/Chrome/" style="font-size: 15px;">Chrome</a> <a href="/tags/Debug/" style="font-size: 15px;">Debug</a> <a href="/tags/Swift/" style="font-size: 15px;">Swift</a> <a href="/tags/ReactiveCocoa/" style="font-size: 15px;">ReactiveCocoa</a> <a href="/tags/Objective-C/" style="font-size: 15px;">Objective-C</a> <a href="/tags/Runtime/" style="font-size: 15px;">Runtime</a> <a href="/tags/Block/" style="font-size: 15px;">Block</a> <a href="/tags/CocoaPods/" style="font-size: 15px;">CocoaPods</a> <a href="/tags/Alfred/" style="font-size: 15px;">Alfred</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2016/04/16/im/">im</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/04/16/Swift_algorithm/">Swift 中简单的算法题</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/04/12/iOS_debug/">iOS 开发中的调试小技巧</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/04/03/Objective-C_initialize_load/">Objective-C 中的 load 和 initialize</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/03/22/Autolayout_flow/">Auto Layout 绘制流程</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/03/16/iOS_database/">Core Data, FMDB, Realm 性能对比</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/03/02/Alfred_3_config/">Alfred 2 配置</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/02/04/CocoaPods_private_library/">使用 CocoaPods 管理私有库</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/01/26/UITableView_Optimization/">UITableView 性能优化</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/12/31/ReactiveCocoa_exploration/">ReactiveCocoa 整理</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-comment-o"> 最近评论</i></div><script type="text/javascript" src="//broccoliii.disqus.com/recent_comments_widget.js?num_items=5&amp;hide_avatars=1&amp;avatar_size=32&amp;excerpt_length=20&amp;hide_mods=1"></script></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://qbeenslee.com/" title="qbeenslee" target="_blank">qbeenslee</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">© <a href="/." rel="nofollow">一朵西兰花.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="/css/jquery.fancybox.css?v=0.0.0"><script>(function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
(w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
})(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');

_st('install','UKkneeeyb79HvjysWVot','2.0.0');
</script><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?64b81a3596d6c5ec76f245076ec9bd2a";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
  })();
</script><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>