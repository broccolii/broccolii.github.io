<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="不求深刻,但求简单."><title>Auto Layout 绘制流程 | 一朵西兰花</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/3.0.3/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/2.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/rss+xml" href="/rss2.xml"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Auto Layout 绘制流程</h1><a id="logo" href="/.">一朵西兰花</a><p class="description">不求深刻,但求简单.</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Auto Layout 绘制流程</h1><div class="post-meta">Mar 2, 2016<script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> Hits</span></span></div><a data-disqus-identifier="2016/03/02/Autolayout_flow/" href="/2016/03/02/Autolayout_flow/#disqus_thread" class="disqus-comment-count"></a><div class="post-content"><p>和朋友讨论 <code>layout</code> 和 <code>constraint</code> 之间的关系, 发现自己并不是很理解 <code>constraint</code> 布局页面的顺序. </p>
<h3 id="Auto_Layout__u7ED8_u5236_u6D41_u7A0B"><a href="#Auto_Layout__u7ED8_u5236_u6D41_u7A0B" class="headerlink" title="Auto Layout 绘制流程"></a>Auto Layout 绘制流程</h3><p>Auto Layout 显示一个 view 时, 会经过 <code>update constraints -&gt; layout views -&gt; display</code> 这三步. 详情请点<a href="http://stackoverflow.com/questions/20609206/setneedslayout-vs-setneedsupdateconstraints-and-layoutifneeded-vs-updateconstra" target="_blank" rel="external">Stackoverflow</a> 如下图所示:</p>
<p><div style="text-align: center"><br><img src="https://raw.githubusercontent.com/broccolii/broccolii.github.io/master/images/Autolayout_flow/constraint_layoutSubview_display.png"><br></div></p>
<blockquote>
<p>引用自:<a href="http://objccn.io/issue-3-5/" target="_blank" rel="external">objc.io 先进的自动布局工具箱</a><br>第一步：update constraints,可以被认为是一个“计量传递 (measurement pass)”.这是自下而上（从子视图到父视图）发生的,它为布局准备好必要的信息,而这些布局将在实际设置视图的 frame 时被传递过去并被使用.你可以通过调用 <code>setNeedsUpdateConstraints</code> 来触发这个操作.同时,你对约束条件系统做出的任何改变都将自动触发这个方法.无论如何,通知自动布局关于自定义视图中任何可能影响布局的改变是非常有用的.谈到自定义视图,你可以在这个阶段重写 <code>updateConstraints</code> 来为你的视图增加需要的本地约束.</p>
<p>第二步：layout views,这是个自上而下（从父视图到子视图）的过程,这种布局操作实际上是通过设置 frame（在 OS X 中）或者 center 和 bounds（在 iOS 中）将约束条件系统的解决方案应用到视图上.你可以通过调用 setNeedsLayout 来触发一个操作请求,这并不会立刻应用布局,而是在稍后再进行处理.因为所有的布局请求将会被合并到一个布局操作中去,所以你不需要为经常调用这个方法而担心.</p>
<p>第三步：display,将 view 渲染到屏幕上,它与是否使用 Auto Layout 无关,其操作是从上向下(从父视图到子视图),通过调用 <code>setNeedsDisplay</code> 触发.</p>
</blockquote>
<p>在图中我们看见,<code>layout views</code> 会触发 <code>updating constraints</code>, 从而触发新的一轮绘制. 原因是: 当 <code>layoutSubviews</code> 被调用时, 会触发 <code>updateConstraintsIfNeeded</code>, 如果进行了 <code>constraint</code> 修改的操作, 那么会调用 <code>updating constraints</code>. 这也就解释了为什么 <code>UIView</code> 动画中,如果修改了 <code>constraint</code> 需要调用 <code>layoutIfNeeded</code>.</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 修改了约束</span></span><br><span class="line">UIView.animateWithDuration(<span class="number">1.0</span>) &#123;</span><br><span class="line">    aniamtionView.layoutIfNeeded()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Constraints"><a href="#Constraints" class="headerlink" title="Constraints"></a>Constraints</h3><p>系统提供了几个关于 <code>constraint</code> 的方法 分别是</p>
<figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">setNeedsUpdateConstraints</span><span class="params">()</span> &#123;&#125;</span></span><br></pre></td></tr></table></figure>
<p>当一个 view 的某个属性发生改变,并且可能影响到 <code>constraint</code> 时. 此方法标记的 <code>constraints</code> 会在未来的某个时间点更新，系统然后调用 <code>updateConstraints</code>.</p>
<figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">needsUpdateConstraints</span><span class="params">()</span> -&gt; <span class="title">Bool</span> &#123;&#125;</span></span><br></pre></td></tr></table></figure>
<p>系统通过这个方法的返回值判断 <code>constraint</code> 是否需要更新.</p>
<figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">updateConstraintsIfNeeded</span><span class="params">()</span> &#123;&#125;</span></span><br></pre></td></tr></table></figure>
<p>立即更新被标记 <code>setNeedsUpdateConstraints</code> 的 <code>constraint</code></p>
<figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">updateConstraints</span><span class="params">()</span> &#123;&#125;</span></span><br></pre></td></tr></table></figure>
<p>自定义 view 时,我们可以重写这个方法做约束修改进行相应的操作.在 <code>viewDidLoad</code> 之后, <code>viewWillLayoutSubviews</code> 之前调用 <strong>注意: 重写这个方法时,一定要调用 super.updateConstraints()</strong></p>
<p>标记 view 的 <code>setNeedsUpdateConstraints</code>,在未来的某个时刻系统调用 <code>needsUpdateConstraints</code> 根据返回值, 会触发 <code>updateConstraints</code>, 然后更新约束. <code>updateConstraintsIfNeeded</code> 则是立即更新所有被标记的 <code>constraint</code>.</p>
<h3 id="layout"><a href="#layout" class="headerlink" title="layout"></a>layout</h3><p>关于 <code>Layout</code> 也有类似 <code>constraint</code> 的几个方法</p>
<figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">setNeedsLayout</span><span class="params">()</span> &#123;&#125;</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">layoutIfNeeded</span><span class="params">()</span> &#123;&#125; </span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">layoutSubviews</span><span class="params">()</span> &#123;&#125;</span></span><br></pre></td></tr></table></figure>
<p>系统会在 <code>RunLoop</code> 周期中的某个时刻自动调用 <code>layoutSubviews</code>.开发者不需要手动调用 <code>layoutSubviews</code>, 只需要重写该方法. <strong>此时并不会发生屏幕绘制.</strong></p>
<blockquote>
<p>The default implementation of this method does nothing on iOS 5.1 and earlier. Otherwise, the default implementation uses any constraints you have set to determine the size and position of any subviews.</p>
<p>Subclasses can override this method as needed to perform more precise layout of their subviews. You should override this method only if the autoresizing and constraint-based behaviors of the subviews do not offer the behavior you want. You can use your implementation to set the frame rectangles of your subviews directly.</p>
<p>You should not call this method directly. If you want to force a layout update, call the setNeedsLayout method instead to do so prior to the next drawing update. If you want to update the layout of your views immediately, call the layoutIfNeeded method.</p>
</blockquote>
<p>官方文档中说明,不要直接调用此方法.如果你想强制更新布局,先调用 <code>setNeedsLayout</code> 方法接着立即调用 <code>layoutIfNeeded</code>.</p>
<p>以下几种情况系统会调用<code>layoutSubviews</code>:</p>
<ul>
<li><code>addSubview</code> 会触发 <code>layoutSubviews</code></li>
<li>修改了 view 的 frame 会触发自身以及父视图的 <code>layoutSubviews</code>.</li>
<li>滚动一个 UIScrollView 会触发 <code>layoutSubviews</code></li>
<li>旋转 Screen 会触发 view 上的 <code>layoutSubviews</code> 事件</li>
</ul>
<h3 id="display"><a href="#display" class="headerlink" title="display"></a>display</h3><p>关于 <code>display</code> 就只有两个方法</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="func"><span class="keyword">func</span> <span class="title">drawRect</span><span class="params">(rect: CGRect)</span></span> &#123;&#125;</span><br><span class="line"><span class="func"><span class="keyword">func</span> <span class="title">setNeedsDisplay</span><span class="params">()</span></span> &#123;&#125;</span><br></pre></td></tr></table></figure>
<p>之所以没有 <code>ifNeeded</code> 方法是因为 <code>display</code> 的绘制周期是 1/60 秒. 关于 <code>drawRect</code> 的一些问题可以看一下 <a href="http://bihongbo.com/2016/01/03/memoryGhostdrawRect/" target="_blank" rel="external">内存恶鬼drawRect</a></p>
<p><strong>Q&amp;A</strong><br>问: 使用 Auto Layout 之后什么时候才能获得正确的 frame?<br>答: <code>viewDidLayoutSubviews</code> 之后</p>
</div><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a data-url="http://broccolii.github.io/2016/03/02/Autolayout_flow/" data-id="cim0ne2z40011vv20o59085jm" class="article-share-link">分享到</a><div class="tags"><a href="/tags/UITableView/">UITableView</a></div><div class="post-nav"><a href="/2016/03/02/Alfred_3_config/" class="pre">Alfred 2 配置</a><a href="/2016/02/04/CocoaPods_private_library/" class="next">使用 CocoaPods 管理私有库</a></div><div id="disqus_thread"><script>var disqus_shortname = 'broccoliii';
var disqus_identifier = '2016/03/02/Autolayout_flow/';
var disqus_title = 'Auto Layout 绘制流程';
var disqus_url = 'http://broccolii.github.io/2016/03/02/Autolayout_flow/';
(function() {
  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//broccoliii.disqus.com/count.js" async></script></div></div></div></div><div class="pure-u-1-4"><div id="sidebar"><div class="widget"><input placeholder="Search" type="text" class="st-default-search-input"/></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/3DTouch/" style="font-size: 15px;">3DTouch</a> <a href="/tags/Alfred/" style="font-size: 15px;">Alfred</a> <a href="/tags/Database/" style="font-size: 15px;">Database</a> <a href="/tags/RunLoop/" style="font-size: 15px;">RunLoop</a> <a href="/tags/CoreSpotlight/" style="font-size: 15px;">CoreSpotlight</a> <a href="/tags/Thread/" style="font-size: 15px;">Thread</a> <a href="/tags/UITableView/" style="font-size: 15px;">UITableView</a> <a href="/tags/ReactiveCocoa/" style="font-size: 15px;">ReactiveCocoa</a> <a href="/tags/Runtime/" style="font-size: 15px;">Runtime</a> <a href="/tags/Block/" style="font-size: 15px;">Block</a> <a href="/tags/CocoaPods/" style="font-size: 15px;">CocoaPods</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2016/03/16/iOS_database/">Core Data, FMDB, Realm 性能对比</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/03/02/Alfred_3_config/">Alfred 2 配置</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/03/02/Autolayout_flow/">Auto Layout 绘制流程</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/02/04/CocoaPods_private_library/">使用 CocoaPods 管理私有库</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/01/26/UITableView_Optimization/">UITableView 性能优化</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/12/31/ReactiveCocoa_exploration/">ReactiveCocoa 整理</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/11/06/iOS9_3D_Touch/">iOS9 中的 3D Touch</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/10/02/iOS9_CoreSpotlight/">iOS9 中的 CoreSpotlight</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/04/21/iOS_UIView_CALayer/">iOS 中的 UIView 和 CALayer</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/02/19/Objective-C_Runtime/">Objective-C 中的 Runtime</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-comment-o"> 最近评论</i></div><script type="text/javascript" src="//broccoliii.disqus.com/recent_comments_widget.js?num_items=5&amp;hide_avatars=1&amp;avatar_size=32&amp;excerpt_length=20&amp;hide_mods=1"></script></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">© <a href="/." rel="nofollow">一朵西兰花.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="/css/jquery.fancybox.css?v=0.0.0"><script>(function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
(w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
})(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');

_st('install','UKkneeeyb79HvjysWVot','2.0.0');
</script><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?64b81a3596d6c5ec76f245076ec9bd2a";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
  })();
</script><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>